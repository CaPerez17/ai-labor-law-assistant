#!/usr/bin/env python
"""
Script de prueba para el servicio de IA (generate_gpt_response y generate_legal_response)

Este script prueba la generaci√≥n de respuestas legales utilizando OpenAI
con documentos simulados relacionados con derecho laboral.
"""

import os
import sys
import json
import logging
from pathlib import Path
from typing import List, Dict, Any

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler()]
)
logger = logging.getLogger("test_gpt")

# Asegurar que el directorio backend est√© en el path
backend_dir = Path(__file__).resolve().parent
if str(backend_dir) not in sys.path:
    sys.path.append(str(backend_dir))

# Importar despu√©s de configurar el path
try:
    from config import validate_config
    from app.services.ai_service import AIService
except ImportError as e:
    logger.error(f"Error importando m√≥dulos: {e}")
    logger.error("Aseg√∫rate de estar ejecutando el script desde el directorio backend/")
    sys.exit(1)

# Documentos de prueba simulados para derecho laboral
def create_test_documents() -> List[Dict[str, Any]]:
    """Crea documentos de prueba relacionados con licencias de maternidad"""
    return [
        {
            "document_id": 1,
            "title": "C√≥digo Sustantivo del Trabajo - Art√≠culo 236",
            "reference_number": "CST-Art.236",
            "document_type": "C√≥digo",
            "content": """
            ART√çCULO 236. LICENCIA EN LA √âPOCA DEL PARTO E INCENTIVOS PARA LA ADECUADA ATENCI√ìN Y CUIDADO DEL RECI√âN NACIDO. 
            
            1. Toda trabajadora en estado de embarazo tiene derecho a una licencia de dieciocho (18) semanas en la √©poca de parto, remunerada con el salario que devengue al momento de iniciar su licencia.
            
            2. Si se tratare de un salario que no sea fijo como en el caso del trabajo a destajo o por tarea, se tomar√° en cuenta el salario promedio devengado por la trabajadora en el √∫ltimo a√±o de servicio, o en todo el tiempo si fuere menor.
            
            3. Para los efectos de la licencia de que trata este art√≠culo, la trabajadora debe presentar al empleador un certificado m√©dico, en el cual debe constar:
               a) El estado de embarazo de la trabajadora;
               b) La indicaci√≥n del d√≠a probable del parto, y
               c) La indicaci√≥n del d√≠a desde el cual debe empezar la licencia, teniendo en cuenta que, por lo menos, ha de iniciarse dos semanas antes del parto.
            
            Los beneficios incluidos en este art√≠culo, y el art√≠culo 239 de la presente ley, no excluyen a los trabajadores del sector p√∫blico.
            """,
            "snippet": "ART√çCULO 236. LICENCIA EN LA √âPOCA DEL PARTO: Toda trabajadora en estado de embarazo tiene derecho a una licencia de dieciocho (18) semanas en la √©poca de parto, remunerada con el salario que devengue al momento de iniciar su licencia.",
            "relevance_score": 0.95
        },
        {
            "document_id": 2,
            "title": "Ley 1822 de 2017",
            "reference_number": "Ley-1822/2017",
            "document_type": "Ley",
            "content": """
            Por medio de la cual se incentiva la adecuada atenci√≥n y cuidado de la primera infancia, se modifican los art√≠culos 236 y 239 del C√≥digo Sustantivo del Trabajo y se dictan otras disposiciones.
            
            Art√≠culo 1¬∞. El art√≠culo 236 del C√≥digo Sustantivo del Trabajo quedar√° as√≠:
            Art√≠culo 236. Licencia en la √©poca del parto e incentivos para la adecuada atenci√≥n y cuidado del reci√©n nacido.
            
            1. Toda trabajadora en estado de embarazo tiene derecho a una licencia de dieciocho (18) semanas en la √©poca de parto, remunerada con el salario que devengue al momento de iniciar su licencia.
            
            2. Si se tratare de un salario que no sea fijo como en el caso del trabajo a destajo o por tarea, se tomar√° en cuenta el salario promedio devengado por la trabajadora en el √∫ltimo a√±o de servicio, o en todo el tiempo si fuere menor.
            
            3. Para los efectos de la licencia de que trata este art√≠culo, la trabajadora debe presentar al empleador un certificado m√©dico, en el cual debe constar:
               a) El estado de embarazo de la trabajadora;
               b) La indicaci√≥n del d√≠a probable del parto, y
               c) La indicaci√≥n del d√≠a desde el cual debe empezar la licencia, teniendo en cuenta que, por lo menos, ha de iniciarse dos semanas antes del parto.
            """,
            "snippet": "Ley 1822 de 2017 - Por medio de la cual se incentiva la adecuada atenci√≥n y cuidado de la primera infancia, se modifican los art√≠culos 236 y 239 del CST. Toda trabajadora tiene derecho a una licencia de 18 semanas en la √©poca del parto.",
            "relevance_score": 0.92
        },
        {
            "document_id": 3,
            "title": "Sentencia T-126 de 2012",
            "reference_number": "SentT-126/2012",
            "document_type": "Sentencia",
            "content": """
            LICENCIA DE MATERNIDAD-Naturaleza y finalidad
            
            La licencia de maternidad es una prestaci√≥n social que consiste en el reconocimiento que la seguridad social le hace a la madre trabajadora cuando se encuentra frente a la maternidad. Esta prestaci√≥n ha sido establecida y regulada legalmente por el poder legislativo, que ha previsto su otorgamiento como una forma de retribuir y equilibrar el aporte que los ciudadanos le hacen a la sociedad y al Estado, por medio de su trabajo, sus aportes tributarios y parafiscales, as√≠ como a trav√©s de las contribuciones que hacen al sistema de seguridad social.
            
            El objetivo principal de la licencia de maternidad es garantizar a la madre el descanso necesario para poder reponerse del parto y prodigarle al reci√©n nacido las atenciones que requiere. El descanso se acompa√±a del pago del salario, pues se parte del supuesto de que si la madre no recibe remuneraci√≥n no podr√≠a satisfacer las necesidades del menor, se afectar√≠a su propia subsistencia, y ello implicar√≠a una vulneraci√≥n a su derecho a la dignidad humana.
            """,
            "snippet": "LICENCIA DE MATERNIDAD-Naturaleza y finalidad: La licencia de maternidad es una prestaci√≥n social que consiste en el reconocimiento que la seguridad social le hace a la madre trabajadora. Su objetivo principal es garantizar a la madre el descanso necesario.",
            "relevance_score": 0.85
        },
        {
            "document_id": 4,
            "title": "Decreto 1072 de 2015",
            "reference_number": "Decreto-1072/2015",
            "document_type": "Decreto",
            "content": """
            ART√çCULO 2.2.1.1.2.1. Acumulaci√≥n de d√≠as de descanso obligatorio remunerado. Cuando las festividades indicadas en el art√≠culo 1¬∫ de la Ley 51 de 1983 coincidan en d√≠a martes, mi√©rcoles o jueves, los trabajadores a los que se aplica esta norma, solo est√°n obligados a laborar el s√°bado siguiente para compensar el descanso correspondiente a dicha festividad.
            
            ART√çCULO 2.2.1.1.3. T√©rmino y modalidades del contrato de trabajo. Pueden celebrarse por tiempo determinado, por el tiempo que dure la realizaci√≥n de una obra o labor determinada, por tiempo indefinido o para ejecutar un trabajo ocasional, accidental o transitorio.
            
            ART√çCULO 2.2.1.1.4. Renovaci√≥n autom√°tica contratos a t√©rmino fijo inferior a un a√±o. Los contratos de trabajo cuya duraci√≥n sea inferior a un (1) a√±o y que sean renovados por tres (3) veces o m√°s, se entender√°n renovados, la √∫ltima vez, por un (1) a√±o.
            """,
            "snippet": "ART√çCULO 2.2.1.1.2.1. Acumulaci√≥n de d√≠as de descanso obligatorio remunerado. ART√çCULO 2.2.1.1.3. T√©rmino y modalidades del contrato de trabajo. ART√çCULO 2.2.1.1.4. Renovaci√≥n autom√°tica contratos a t√©rmino fijo inferior a un a√±o.",
            "relevance_score": 0.45
        },
        {
            "document_id": 5,
            "title": "Ley 1468 de 2011",
            "reference_number": "Ley-1468/2011",
            "document_type": "Ley",
            "content": """
            Art√≠culo 1¬∞. El art√≠culo 236 del C√≥digo Sustantivo del Trabajo quedar√° as√≠:
            
            Art√≠culo 236. Descanso remunerado en la √©poca del parto:
            
            1. Toda trabajadora en estado de embarazo tiene derecho a una licencia de catorce (14) semanas en la √©poca de parto, remunerada con el salario que devengue al entrar a disfrutar del descanso.
            
            2. Si se tratare de un salario que no sea fijo, como en el caso del trabajo a destajo o por tarea, se toma en cuenta el salario promedio devengado por la trabajadora en el √∫ltimo a√±o de servicios, o en todo el tiempo si fuere menor.
            
            3. Para los efectos de la licencia de que trata este art√≠culo, la trabajadora debe presentar al empleador un certificado m√©dico, en el cual debe constar:
            
            a) El estado de embarazo de la trabajadora;
            b) La indicaci√≥n del d√≠a probable del parto, y
            c) La indicaci√≥n del d√≠a desde el cual debe empezar la licencia, teniendo en cuenta que, por lo menos, ha de iniciarse dos semanas antes del parto.
            """,
            "snippet": "Ley 1468 de 2011: Toda trabajadora en estado de embarazo tiene derecho a una licencia de catorce (14) semanas en la √©poca de parto, remunerada con el salario que devengue al entrar a disfrutar del descanso.",
            "relevance_score": 0.78
        }
    ]

def test_simple_gpt_response():
    """Prueba la funci√≥n generate_gpt_response con un prompt simple"""
    logger.info("üß™ Probando generate_gpt_response con prompt simple")
    
    # Verificar configuraci√≥n
    if not validate_config():
        logger.error("‚ùå Configuraci√≥n de OpenAI inv√°lida. No se puede continuar.")
        return False
    
    # Inicializar el servicio
    ai_service = AIService()
    
    # Prompt de prueba simple
    system_message = "Eres un asistente legal especializado en derecho laboral colombiano."
    user_prompt = "Explica brevemente qu√© es una licencia de maternidad seg√∫n la legislaci√≥n colombiana."
    
    # Generar respuesta
    logger.info("üì§ Enviando prompt a OpenAI...")
    response, error = ai_service.generate_gpt_response(
        prompt=user_prompt,
        system_message=system_message,
        max_tokens=300,
        temperature=0.3
    )
    
    if error:
        logger.error(f"‚ùå Error al generar respuesta: {error}")
        return False
    
    logger.info("‚úÖ Respuesta generada correctamente:")
    logger.info("-" * 80)
    logger.info(response[:500] + "..." if len(response) > 500 else response)
    logger.info("-" * 80)
    
    return True

def test_legal_response():
    """Prueba la funci√≥n generate_legal_response con documentos simulados"""
    logger.info("üß™ Probando generate_legal_response con documentos simulados")
    
    # Verificar configuraci√≥n
    if not validate_config():
        logger.error("‚ùå Configuraci√≥n de OpenAI inv√°lida. No se puede continuar.")
        return False
    
    # Inicializar el servicio
    ai_service = AIService()
    
    # Crear documentos de prueba
    test_docs = create_test_documents()
    
    # Consulta de prueba
    query = "¬øCu√°ntas semanas de licencia de maternidad me corresponden seg√∫n la ley colombiana y qu√© requisitos debo cumplir?"
    
    # Generar respuesta legal
    logger.info(f"üì§ Generando respuesta legal para: '{query}'")
    response, confidence, cited_docs, requires_review = ai_service.generate_legal_response(
        query_text=query,
        search_results=test_docs,
        max_documents=4
    )
    
    logger.info("‚úÖ Respuesta legal generada correctamente:")
    logger.info("-" * 80)
    logger.info(response[:800] + "..." if len(response) > 800 else response)
    logger.info("-" * 80)
    logger.info(f"üìä Puntuaci√≥n de confianza: {confidence:.2f}")
    
    logger.info("üìö Documentos citados:")
    for doc in cited_docs:
        logger.info(f"  - {doc.get('title', 'Sin t√≠tulo')} (Relevancia: {doc.get('relevance', 0):.2f})")
    
    logger.info(f"üëÅÔ∏è Requiere revisi√≥n humana: {requires_review}")
    
    return True

def run_all_tests():
    """Ejecuta todas las pruebas disponibles"""
    logger.info("üîç Iniciando pruebas del servicio de IA")
    logger.info("=" * 80)
    
    tests = [
        ("Respuesta GPT simple", test_simple_gpt_response),
        ("Respuesta legal con documentos", test_legal_response)
    ]
    
    results = []
    
    for name, test_func in tests:
        logger.info(f"\nüß™ Ejecutando prueba: {name}")
        logger.info("-" * 80)
        
        success = test_func()
        results.append((name, success))
        
        if success:
            logger.info(f"‚úÖ Prueba '{name}' completada con √©xito")
        else:
            logger.error(f"‚ùå Prueba '{name}' fall√≥")
    
    # Mostrar resumen
    logger.info("\n" + "=" * 80)
    logger.info("üìã RESUMEN DE PRUEBAS")
    logger.info("=" * 80)
    
    all_passed = True
    for name, result in results:
        status = "‚úÖ PAS√ì" if result else "‚ùå FALL√ì"
        if not result:
            all_passed = False
        logger.info(f"{status} - {name}")
    
    logger.info("=" * 80)
    if all_passed:
        logger.info("üéâ Todas las pruebas pasaron correctamente")
    else:
        logger.error("‚ö†Ô∏è Algunas pruebas fallaron")
    
    return all_passed

if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1) 